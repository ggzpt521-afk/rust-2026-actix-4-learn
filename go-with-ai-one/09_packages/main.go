// ============================================================================
// 09_packages - 包与模块管理
// ============================================================================
// 这是一个独立的 Go 模块，展示包的组织方式
//
// 【目录结构】
// 09_packages/
// ├── main.go           (主程序，package main)
// ├── go.mod            (模块定义文件)
// ├── mathutil/
// │   └── mathutil.go   (数学工具包)
// └── stringutil/
//     └── stringutil.go (字符串工具包)
//
// 【运行方式】
// cd 09_packages && go mod init example.com/packages && go run main.go
//
// 或者直接运行（如果已初始化模块）:
// cd 09_packages && go run main.go
//
// 【本文件学习目标】
// 1. 理解 Go 的包组织机制
// 2. 掌握 Go Modules 依赖管理
// 3. 学会创建和使用自定义包
// 4. 理解导入路径和可见性规则
// 5. 了解 init 函数的执行机制
//
// 【包的核心概念】
// - 包是 Go 代码的基本组织单位
// - 每个 Go 文件必须声明所属的包
// - 同一目录下的所有 .go 文件必须属于同一个包
// - main 包是可执行程序的入口
// ============================================================================

package main

import (
	"fmt"
)

// ============================================================================
// 【导入包的方式】
// ============================================================================
// 以下是注释掉的导入示例，展示如何导入本地包
// 需要先运行 go mod init example.com/packages
//
// 【导入语法】
// import "包路径"           // 单个导入
// import (                   // 批量导入
//     "包路径1"
//     "包路径2"
// )
//
// 【特殊导入方式】
// import alias "包路径"     // 别名导入，使用 alias.Func()
// import . "包路径"         // 点导入，直接使用 Func()（不推荐）
// import _ "包路径"         // 空白导入，只执行 init 函数
// ============================================================================

// 注意：以下导入路径需要先运行 go mod init example.com/packages
// import (
//     "example.com/packages/mathutil"
//     "example.com/packages/stringutil"
// )

func main() {
	fmt.Println("=== Go 包与模块管理 ===\n")

	// ========================================================================
	// 【包的基本概念】
	// ========================================================================
	// 包是 Go 中代码复用和组织的基本单位
	//
	// 【包的作用】
	// 1. 代码组织：将相关功能放在一起
	// 2. 命名空间：避免名称冲突
	// 3. 访问控制：大写开头导出，小写开头私有
	// 4. 依赖管理：明确的依赖关系
	//
	// 【包命名规范】
	// - 简短、清晰、小写
	// - 不要使用下划线或驼峰
	// - 不要与标准库包名冲突
	// - 通常使用目录名作为包名
	// ========================================================================
	fmt.Println("--- 包的基本概念 ---")
	fmt.Println("1. 每个 Go 文件必须属于一个包")
	fmt.Println("2. main 包是程序入口")
	fmt.Println("3. 大写开头的标识符是导出的（公开的）")
	fmt.Println("4. 小写开头的标识符是私有的（包内可见）")

	// ========================================================================
	// 【导入方式详解】
	// ========================================================================
	// Go 提供多种导入包的方式
	//
	// 【标准导入】
	// import "fmt"
	// 使用：fmt.Println(...)
	//
	// 【别名导入】
	// import f "fmt"
	// 使用：f.Println(...)
	// 适用场景：包名冲突、包名太长
	//
	// 【点导入】（不推荐）
	// import . "fmt"
	// 使用：Println(...) // 不需要包名前缀
	// 问题：降低代码可读性，容易名称冲突
	//
	// 【空白导入】
	// import _ "github.com/go-sql-driver/mysql"
	// 只执行包的 init 函数，不使用其他内容
	// 典型用途：数据库驱动注册
	// ========================================================================
	fmt.Println("\n--- 导入方式 ---")
	fmt.Println(`
// 单个导入
import "fmt"

// 批量导入（推荐方式）
import (
    "fmt"
    "strings"
    "math"
)

// 别名导入
import (
    f "fmt"           // 使用 f.Println()
    . "strings"       // 点导入（不推荐）
    _ "database/sql"  // 空白导入（仅执行 init）
)
`)

	// ========================================================================
	// 【Go Modules 模块管理】
	// ========================================================================
	// Go 1.11+ 引入的官方依赖管理系统
	//
	// 【核心文件】
	// - go.mod：定义模块路径和依赖
	// - go.sum：记录依赖的校验和（确保完整性）
	//
	// 【模块路径】
	// - 通常是代码仓库的 URL：github.com/user/project
	// - 本地项目可以使用任意路径：example.com/myproject
	//
	// 【版本选择】
	// - Go 使用语义化版本（Semantic Versioning）
	// - v1.2.3：主版本.次版本.补丁版本
	// - 主版本变化表示不兼容的改动
	// ========================================================================
	fmt.Println("--- Go Modules (go mod) ---")
	fmt.Println(`
常用命令:
  go mod init <module-path>  # 初始化模块，创建 go.mod
  go mod tidy                # 整理依赖：添加缺少的，删除多余的
  go mod download            # 下载依赖到本地缓存
  go mod verify              # 验证依赖的完整性
  go mod graph               # 显示依赖关系图
  go mod vendor              # 将依赖复制到 vendor 目录
  go get <package>           # 添加或更新依赖
  go get <package>@version   # 获取指定版本
  go get <package>@latest    # 获取最新版本
`)

	// ========================================================================
	// 【go.mod 文件详解】
	// ========================================================================
	// go.mod 是模块的核心配置文件
	//
	// 【指令说明】
	// - module：声明模块路径
	// - go：指定 Go 版本
	// - require：声明依赖
	// - replace：替换依赖路径（本地开发、fork 等）
	// - exclude：排除特定版本
	// - retract：撤回已发布的版本
	//
	// 【indirect 标记】
	// require xxx // indirect
	// 表示间接依赖（被其他依赖引入的依赖）
	// ========================================================================
	fmt.Println("--- go.mod 文件示例 ---")
	fmt.Println(`
module example.com/myproject    // 模块路径

go 1.21                          // 最低 Go 版本

require (
    // 直接依赖
    github.com/gin-gonic/gin v1.9.1
    github.com/go-sql-driver/mysql v1.7.1
)

require (
    // 间接依赖会自动管理
    golang.org/x/net v0.17.0 // indirect
)

replace (
    // 本地开发时替换模块路径
    // 常用于：开发本地 fork、调试依赖
    example.com/oldmodule => ../newmodule
)

exclude (
    // 排除特定版本（有 bug 或安全问题）
    github.com/bad/package v1.0.0
)
`)

	// ========================================================================
	// 【项目结构最佳实践】
	// ========================================================================
	// Go 社区推荐的项目结构
	//
	// 【重要目录】
	// - cmd/：可执行程序的入口
	// - internal/：内部包，不能被外部项目导入
	// - pkg/：可被外部项目导入的包
	// - api/：API 定义（如 protobuf、OpenAPI）
	// - web/：Web 相关资源
	//
	// 【internal 目录的特殊性】
	// Go 编译器会阻止其他模块导入 internal 目录下的包
	// 这提供了一种强制的封装机制
	// ========================================================================
	fmt.Println("--- 包的组织建议 ---")
	fmt.Println(`
项目结构示例:
myproject/
├── go.mod               # 模块定义
├── go.sum               # 依赖校验和
├── main.go              # 简单项目的入口
├── cmd/                 # 可执行程序
│   ├── server/
│   │   └── main.go      # go build ./cmd/server
│   └── client/
│       └── main.go      # go build ./cmd/client
├── internal/            # 内部包（不可被外部导入！）
│   ├── config/
│   └── database/
├── pkg/                 # 可被外部导入的公共包
│   └── utils/
├── api/                 # API 定义
├── web/                 # Web 资源
└── scripts/             # 脚本
`)

	// ========================================================================
	// 【init 函数】
	// ========================================================================
	// init 是特殊的初始化函数
	//
	// 【特点】
	// - 没有参数，没有返回值
	// - 不能被显式调用
	// - 一个包可以有多个 init 函数
	// - 一个文件可以有多个 init 函数
	//
	// 【执行顺序】
	// 1. 导入的包的 init 函数（按导入顺序，深度优先）
	// 2. 包级变量初始化
	// 3. 当前包的 init 函数
	// 4. main 函数（只对 main 包）
	//
	// 【常见用途】
	// - 初始化复杂的包级变量
	// - 注册功能（如数据库驱动）
	// - 检查环境配置
	//
	// 【注意】
	// - 不要在 init 中执行耗时操作
	// - 避免 init 函数之间的依赖
	// - 尽量减少 init 的使用，优先使用显式初始化
	// ========================================================================
	fmt.Println("--- init 函数 ---")
	fmt.Println(`
// init 函数在包被导入时自动执行
// 执行顺序: 导入包的 init -> 当前包的 init -> main

// 一个包可以有多个 init 函数
func init() {
    // 初始化配置
    // 注册驱动
    // 检查环境
}

// 典型用法：数据库驱动注册
import _ "github.com/go-sql-driver/mysql"
// mysql 包的 init() 会注册驱动到 database/sql
`)

	// ========================================================================
	// 【使用本地包示例】
	// ========================================================================
	// 演示如何使用本地定义的包
	//
	// 【步骤】
	// 1. 创建包目录和文件
	// 2. 在 go.mod 中定义模块路径
	// 3. 使用 模块路径/包名 导入
	// ========================================================================
	fmt.Println("--- 使用本地包示例 ---")

	// 如果模块已初始化，可以这样使用：
	// result := mathutil.Add(3, 5)
	// fmt.Printf("mathutil.Add(3, 5) = %d\n", result)
	//
	// reversed := stringutil.Reverse("Hello")
	// fmt.Printf("stringutil.Reverse(\"Hello\") = %s\n", reversed)

	// 演示替代（因为没有实际导入）
	fmt.Println("mathutil.Add(3, 5) = 8")
	fmt.Println("mathutil.Factorial(5) = 120")
	fmt.Println("stringutil.Reverse(\"Hello\") = \"olleH\"")
	fmt.Println("stringutil.IsPalindrome(\"radar\") = true")

	// ========================================================================
	// 【包管理最佳实践】
	// ========================================================================
	// 总结 Go 包管理的关键实践
	//
	// 【命名】
	// - 包名简短、小写、单数
	// - 避免使用 common、util、shared 等无意义名称
	// - 使用描述性名称：http、json、strings
	//
	// 【组织】
	// - 按功能而非类型组织（不要 models/、controllers/）
	// - 使用 internal/ 隐藏实现细节
	// - 小包优于大包
	//
	// 【依赖】
	// - 定期运行 go mod tidy
	// - 提交 go.mod 和 go.sum 到版本控制
	// - 谨慎升级主版本依赖
	// ========================================================================
	fmt.Println("\n--- 包管理最佳实践 ---")
	fmt.Println("1. 包名应该简短、清晰、小写")
	fmt.Println("2. 避免包名与标准库冲突")
	fmt.Println("3. 使用 internal/ 目录存放内部包")
	fmt.Println("4. 定期运行 go mod tidy 清理依赖")
	fmt.Println("5. 提交 go.sum 文件到版本控制")
	fmt.Println("6. 使用语义化版本 (v1.2.3)")
}

// ============================================================================
// 【init 函数示例】
// ============================================================================
// 这个 init 函数会在 main 之前执行
// 可以用于初始化包级状态
// ============================================================================
func init() {
	// 这会在 main 之前执行
	// 可以在这里进行初始化工作
	_ = "包初始化" // 占位，避免编译器警告
}
