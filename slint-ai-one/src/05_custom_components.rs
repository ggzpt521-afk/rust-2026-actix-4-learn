// ============================================================================
// 05_custom_components.rs - Slint 自定义组件示例
// ============================================================================
//
// 【核心概念】
// 自定义组件是构建可复用 UI 的基础：
// 1. 封装 UI 结构和逻辑
// 2. 通过属性接收外部数据
// 3. 通过回调向外发送事件
// 4. 可以在多处复用，保持一致性
//
// 【原理说明】
// Slint 的组件系统类似于其他框架的组件概念：
// - 组件是 UI 和逻辑的封装单元
// - 组件有自己的属性、状态和行为
// - 组件可以嵌套和复用
// - 父组件通过属性向子组件传递数据
// - 子组件通过回调向父组件发送事件
// ============================================================================

slint::slint! {
    // 导入标准按钮组件
    import { Button } from "std-widgets.slint";

    // ========================================================================
    // 自定义组件定义
    // ========================================================================
    // component: 声明一个组件（不带 export 表示内部组件）
    // 内部组件只能在同一个 slint! 块或文件中使用
    // 外部组件 (export component) 可以从 Rust 代码访问
    //
    // 【组件设计原则】
    // 1. 单一职责：每个组件做一件事
    // 2. 可复用：通过属性配置行为
    // 3. 封装性：隐藏内部实现细节
    // 4. 组合性：小组件组合成大组件
    component SimpleCounter {
        // ====================================================================
        // 组件属性 (Props)
        // ====================================================================
        // in property: 输入属性，由父组件设置
        // - 类似于 React 的 props
        // - 子组件不能修改 in 属性
        // - 用于配置组件的外观和行为

        // 标签文本，显示在计数器旁边
        in property <string> label: "计数器";

        // 初始值，组件创建时的起始值
        in property <int> initial-value: 0;

        // ====================================================================
        // 组件状态
        // ====================================================================
        // in-out property: 双向属性，内外都可修改
        // - 这里用作组件的内部状态
        // - 初始化为 initial-value 的值
        // - 用户操作会修改这个值
        in-out property <int> value: initial-value;

        // ====================================================================
        // 组件内部布局
        // ====================================================================
        // 组件的 UI 结构定义
        // 这部分对外部是隐藏的，外部只能通过属性和回调交互
        HorizontalLayout {
            spacing: 10px;

            // 显示标签
            Text {
                text: label;
                font-size: 14px;
                vertical-alignment: center;
            }

            // 减少按钮
            Button {
                text: "-";
                // 修改组件内部状态
                // 这个操作对外部是透明的
                clicked => { value = value -  1 ; }
            }

            // 显示当前值
            Text {
                text: value;  // 绑定到组件状态
                font-size: 16px;
                width: 40px;
                horizontal-alignment: center;
                vertical-alignment: center;
            }

            // 增加按钮
            Button {
                text: "+";
                clicked => { value = value + 1; }
            }
        }

        // ====================================================================
        // 【扩展】组件回调
        // ====================================================================
        // callback: 声明组件可以发出的事件
        // 语法：callback 回调名(参数类型, ...);
        //
        // 示例（已注释）：
        // callback value-changed(int);  // 值改变时发出
        //
        // 在内部触发回调：
        // clicked => { value = value + 1; value-changed(value); }
        //
        // 父组件监听回调：
        // SimpleCounter {
        //     value-changed(new-val) => { /* 处理 */ }
        // }
    }

    // ========================================================================
    // 主应用组件
    // ========================================================================
    // export component: 导出组件，可从 Rust 访问
    // inherits Window: 作为顶层窗口
    export component CustomComponents inherits Window {
        width: 400px;
        height: 300px;
        title: "自定义组件示例";

        // 应用级状态
        in-out property <int> total: 0;

        VerticalLayout {
            padding: 20px;
            spacing: 15px;

            Text {
                text: "自定义组件示例";
                font-size: 24px;
                color: #333;
            }

            // ================================================================
            // 使用自定义组件
            // ================================================================
            // 像使用内置组件一样使用自定义组件
            // 通过属性传递配置

            // 第一个计数器实例
            SimpleCounter {
                // 设置 in 属性
                label: "计数器 1";
                initial-value: 5;

                // 【注意】也可以绑定/监听 in-out 属性
                // 例如：value: some-external-property;
            }

            // 第二个计数器实例
            // 同一个组件可以创建多个实例
            // 每个实例有独立的状态
            SimpleCounter {
                label: "计数器 2";
                initial-value: 10;
            }

            // 第三个计数器实例
            SimpleCounter {
                label: "计数器 3";
                initial-value: 15;
            }

            // 【演示】三个 SimpleCounter 实例
            // - 共享相同的组件定义
            // - 各自维护独立的状态 (value)
            // - 通过不同的属性值进行配置
        }
    }
}

// ============================================================================
// main 函数
// ============================================================================
fn main() {
    // 创建应用实例
    let app = CustomComponents::new().unwrap();

    // ------------------------------------------------------------------------
    // 【扩展】访问子组件
    // ------------------------------------------------------------------------
    // 如果需要从 Rust 访问特定的子组件实例，需要：
    // 1. 给子组件实例命名（目前 Slint 通过 global 实现）
    // 2. 或者使用 global 全局单例暴露接口
    //
    // 示例（概念性，非实际代码）：
    // global CounterState {
    //     in-out property <int> counter1-value;
    //     in-out property <int> counter2-value;
    // }
    //
    // 然后在 Rust 中：
    // app.global::<CounterState>().set_counter1_value(100);

    app.run().unwrap();
}

// ============================================================================
// 【知识点总结】
// ============================================================================
//
// 1. 组件定义
//    - component Name { ... }: 内部组件
//    - export component Name { ... }: 可导出组件
//    - inherits Parent: 继承父组件
//
// 2. 组件属性
//    - in property: 输入属性（只读，由父组件设置）
//    - out property: 输出属性（只写，向父组件暴露）
//    - in-out property: 双向属性
//    - private property: 私有属性（默认）
//
// 3. 组件回调
//    - callback name(params): 声明回调
//    - name(args): 在组件内调用回调
//    - ChildComponent { name(args) => { ... } }: 父组件监听
//
// 4. 组件复用
//    - 同一组件可创建多个实例
//    - 每个实例有独立的状态
//    - 通过属性配置每个实例
//
// 5. 组件设计模式
//    - 受控组件：状态由父组件管理
//    - 非受控组件：状态由组件自身管理
//    - 混合模式：初始值由父组件设置，运行时自行管理
//
// 6. 与其他框架对比
//    - Slint component ≈ React Component / Vue Component
//    - Slint in property ≈ React props / Vue props
//    - Slint callback ≈ React callback props / Vue emit
// ============================================================================
