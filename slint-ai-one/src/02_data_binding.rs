// ============================================================================
// 02_data_binding.rs - Slint 数据绑定示例
// ============================================================================
//
// 【核心概念】
// 数据绑定是现代 UI 框架的核心特性，它建立了数据和 UI 之间的自动同步关系：
// 1. 当数据变化时，UI 自动更新
// 2. 当用户操作 UI 时，数据自动更新
// 3. 无需手动操作 DOM 或调用更新方法
//
// 【原理说明】
// Slint 的数据绑定基于响应式编程模型：
// - 每个属性都是一个"信号" (Signal)
// - 当属性被读取时，建立依赖关系
// - 当属性被修改时，自动通知所有依赖项更新
// - 这种机制称为"依赖追踪" (Dependency Tracking)
// ============================================================================

slint::slint! {
    // ------------------------------------------------------------------------
    // 导入标准组件库
    // ------------------------------------------------------------------------
    // Slint 提供了一套标准组件库 "std-widgets.slint"
    // 包含常用的 UI 控件：Button, LineEdit, CheckBox, ComboBox 等
    // 这些组件已经实现了样式和交互逻辑
    import { LineEdit, Button } from "std-widgets.slint";

    export component DataBinding inherits Window {
        width: 400px;
        height: 350px;
        title: "数据绑定示例";

        // ====================================================================
        // 属性声明 - Slint 数据绑定的基础
        // ====================================================================
        //
        // 【属性修饰符详解】
        //
        // in property: 输入属性
        // - 只能从外部 (Rust) 设置
        // - 组件内部只能读取，不能修改
        // - 用于向组件传递配置或数据
        //
        // out property: 输出属性
        // - 只能从组件内部设置
        // - 外部 (Rust) 只能读取
        // - 用于向外部暴露组件状态
        //
        // in-out property: 双向属性
        // - 内部和外部都可以读写
        // - 用于需要双向同步的数据
        //
        // private property: 私有属性 (默认)
        // - 只能在组件内部使用
        // - 外部无法访问

        // --------------------------------------------------------------------
        // in-out property <类型> 名称: 默认值;
        // --------------------------------------------------------------------
        // <string>: 属性类型为字符串
        // user-name: 属性名称 (在 Rust 中会转换为 user_name)
        // "Guest": 默认值
        in-out property <string> user-name: "Guest";

        // <int>: 整数类型
        // 其他常用类型：
        // - float: 浮点数
        // - bool: 布尔值
        // - color: 颜色
        // - length: 长度 (带单位)
        // - duration: 时间长度
        // - image: 图像
        // - [T]: 数组类型
        in-out property <int> counter: 0;

        // in property: 只读属性，用于外部传入的配置
        in property <string> app-title: "数据绑定示例";

        // 主布局区域
        Rectangle {
            width: 100%;    // 100% 表示填满父元素
            height: 100%;
            background: #f0f0f0;

            // ----------------------------------------------------------------
            // VerticalLayout - 垂直布局容器
            // ----------------------------------------------------------------
            // 子元素从上到下依次排列
            // 与 CSS 的 flexbox (flex-direction: column) 类似
            VerticalLayout {
                // padding: 内边距，元素内容与边框的距离
                padding: 20px;
                // spacing: 子元素之间的间距
                spacing: 10px;

                // ------------------------------------------------------------
                // 属性绑定表达式
                // ------------------------------------------------------------
                // text: app-title 是一个绑定表达式
                // 当 app-title 属性变化时，这个 Text 会自动更新
                Text {
                    text: app-title;  // 绑定到 app-title 属性
                    font-size: 24px;
                    color: #333;
                }

                // HorizontalLayout: 水平布局，子元素从左到右排列
                HorizontalLayout {
                    spacing: 10px;

                    Text {
                        text: "用户名:";
                        font-size: 16px;
                        // vertical-alignment: 垂直居中对齐
                        vertical-alignment: center;
                    }

                    // --------------------------------------------------------
                    // LineEdit - 文本输入框
                    // --------------------------------------------------------
                    // 标准库提供的输入组件
                    LineEdit {
                        // 双向绑定：显示 user-name 的值
                        text: user-name;
                        width: 200px;

                        // --------------------------------------------------
                        // 事件回调 - edited 事件
                        // --------------------------------------------------
                        // edited => { ... } 是事件回调语法
                        // 当用户编辑文本后触发
                        //
                        // self.text: 获取当前 LineEdit 的文本值
                        // user-name = self.text: 将新值赋给 user-name 属性
                        //
                        // 【原理】这就是"双向绑定"的实现：
                        // 1. text: user-name 实现了 属性 -> UI 的绑定
                        // 2. edited => { user-name = self.text } 实现了 UI -> 属性 的绑定
                        edited => { user-name = self.text; }
                    }
                }

                // ------------------------------------------------------------
                // 字符串拼接
                // ------------------------------------------------------------
                // Slint 支持在绑定表达式中使用 + 运算符拼接字符串
                // 当任一部分变化时，整个表达式会重新计算
                Text {
                    // "欢迎，" + user-name + "！" 是一个计算属性
                    // 每当 user-name 变化，这个文本就会自动更新
                    text: "欢迎，" + user-name + "！";
                    font-size: 18px;
                    color: #0066cc;
                }

                // 计数器区域
                HorizontalLayout {
                    spacing: 10px;

                    // --------------------------------------------------------
                    // Button - 按钮组件
                    // --------------------------------------------------------
                    Button {
                        text: "-";
                        // clicked => { ... } 点击事件回调
                        // counter = counter - 1: 减少计数器
                        // 注意：表达式两边需要空格，避免被解析为属性名
                        clicked => { counter = counter - 1 ; }
                    }

                    // ------------------------------------------------------------
                    // 数字到字符串的自动转换
                    // ------------------------------------------------------------
                    // text: counter 会自动将 int 转换为 string
                    // Slint 支持多种类型的自动转换
                    Text {
                        text: counter;  // int 自动转为 string
                        font-size: 20px;
                        width: 50px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }

                    Button {
                        text: "+";
                        clicked => { counter = counter + 1; }
                    }
                }

                // 显示计数器状态 - 字符串与数字拼接
                Text {
                    // "当前计数: " + counter 会自动转换 counter 为字符串
                    text: "当前计数: " + counter;
                    color: #333;
                }
            }
        }
    }
}

// ============================================================================
// main 函数
// ============================================================================
fn main() {
    // 创建组件实例
    let app = DataBinding::new().unwrap();

    // ------------------------------------------------------------------------
    // 从 Rust 设置属性
    // ------------------------------------------------------------------------
    // set_app_title(): 自动生成的 setter 方法
    // 属性名 app-title 在 Rust 中转换为 app_title
    // setter 方法名为 set_app_title
    //
    // .into(): 将 &str 转换为 SharedString (Slint 的字符串类型)
    // SharedString 是 Slint 的内部字符串类型，支持高效的共享和拷贝
    app.set_app_title("Slint 数据绑定示例".into());

    // 【其他自动生成的方法】
    // - get_app_title(): 获取属性值
    // - get_user_name() / set_user_name(): user-name 的 getter/setter
    // - get_counter() / set_counter(): counter 的 getter/setter

    // 运行应用
    app.run().unwrap();
}

// ============================================================================
// 【知识点总结】
// ============================================================================
//
// 1. 属性系统
//    - in/out/in-out 修饰符控制访问方向
//    - 支持多种数据类型：string, int, float, bool, color 等
//    - 属性值变化会自动触发 UI 更新
//
// 2. 数据绑定表达式
//    - 直接绑定：text: property-name
//    - 计算绑定：text: "Hello, " + name + "!"
//    - 类型自动转换：int -> string
//
// 3. 双向绑定
//    - 属性 -> UI: 通过属性绑定自动实现
//    - UI -> 属性: 通过事件回调手动实现
//    - 完整双向绑定 = 属性绑定 + 事件回调
//
// 4. 事件回调语法
//    - event-name => { statements; }
//    - 常用事件：clicked, edited, changed
//
// 5. Rust 集成
//    - set_xxx(): 设置属性
//    - get_xxx(): 获取属性
//    - .into(): 字符串类型转换
// ============================================================================
