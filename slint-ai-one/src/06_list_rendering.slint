// ============================================================================
// 06_list_rendering.slint - Slint 列表渲染示例
// ============================================================================
//
// 【文件说明】
// 本文件演示 Slint 的列表渲染功能
// 列表渲染是动态 UI 的核心，用于显示数组数据
//
// 【与 .rs 文件的关联】
// - 列表数据通常从 Rust 传入
// - 使用 VecModel<T> 在 Rust 中管理动态数组
// - 数组操作（增删改）在 Rust 中完成
// - 通过 callback 通知 Rust 执行操作
//
// 【列表渲染原理】
// 1. for item in array: 遍历数组
// 2. 为每个元素创建 UI 实例
// 3. 数组变化时，Slint 使用 diff 算法更新
// 4. 只重新渲染变化的部分
//
// 【性能优化】
// - Slint 内置 diff 算法
// - 大列表使用 ListView（虚拟化）
// - 避免频繁重建整个数组
// ============================================================================

// ============================================================================
// 结构体定义 - 列表项数据模型
// ============================================================================
// export struct: 导出结构体，可在 Rust 中使用
//
// 【与 Rust 的关联】
// Slint 会生成对应的 Rust 结构体：
// #[derive(Clone, Default)]
// pub struct TodoItem {
//     pub id: i32,
//     pub title: SharedString,
//     pub completed: bool,
//     pub priority: SharedString,
// }
//
// 在 Rust 中创建：
// let item = TodoItem {
//     id: 1,
//     title: "任务".into(),
//     completed: false,
//     priority: "高".into(),
// };
export struct TodoItem {
    id: int,           // 唯一标识符
    title: string,     // 任务标题
    completed: bool,   // 是否完成
    priority: string,  // 优先级：高/中/低
}

// ============================================================================
// 列表项组件 - 可复用的列表项 UI
// ============================================================================
// 将列表项封装为独立组件，提高复用性和可维护性
//
// 【设计原则】
// - 接收单个数据项作为输入
// - 通过回调通知父组件操作
// - 保持组件独立性
export component TodoItemComponent inherits Rectangle {
    // 输入属性：接收数据项
    in property <TodoItem> item;

    // 组件尺寸和样式
    width: 100%;
    height: 60px;
    background: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 12px;

    HorizontalLayout {
        spacing: 12px;
        vertical-alignment: center;

        // ====================================================================
        // 复选框 - 完成状态
        // ====================================================================
        // 绑定到 item.completed 字段
        CheckBox {
            checked: item.completed;
            on-toggled: {
                // 更新完成状态
                // 注意：结构体字段不能直接修改
                // 实际应用中需要通过回调通知 Rust
                item.completed = checked;
            }
        }

        // 内容区域
        VerticalLayout {
            spacing: 4px;

            // 任务标题
            // 根据完成状态改变样式
            Text {
                text: item.title;
                font-size: 16px;
                // 条件表达式：完成时显示灰色
                color: item.completed ? #999 : #333;
                // 完成时添加删除线（Slint 0.x 语法）
                text-decoration: item.completed ? line-through : none;
                width: 250px;
                word-wrap: true;
            }

            // ================================================================
            // 优先级标签
            // ================================================================
            // 使用函数根据优先级返回颜色
            Rectangle {
                width: 60px;
                height: 20px;
                background: priority_color();
                border-radius: 10px;

                Text {
                    text: item.priority;
                    font-size: 12px;
                    color: white;
                    vertical-alignment: center;
                    horizontal-alignment: center;
                }
            }
        }

        // 删除按钮
        Button {
            text: "删除";
            width: 60px;
            height: 30px;
            font-size: 12px;
            background: #ff4444;
            color: white;
            border-radius: 4px;

            on-clicked: {
                // 调用回调，通知删除此项
                // 传递 id 给 Rust 处理
                remove-item(item.id);
            }
        }
    }

    // 根据优先级返回颜色
    function priority_color() -> color {
        if item.priority == "高" {
            return #ff4444;  // 高优先级：红色
        } else if item.priority == "中" {
            return #ff9900;  // 中优先级：橙色
        } else {
            return #009900;  // 低优先级：绿色
        }
    }
}

// ============================================================================
// 主应用组件
// ============================================================================
export component ListRendering {
    width: 500px;
    height: 500px;

    // ========================================================================
    // 数组属性
    // ========================================================================
    // <[StructName]>: 结构体数组类型
    //
    // 【与 Rust 的关联】
    // 数组在 Rust 中对应 ModelRc<T> 类型
    // 可以使用 VecModel<T> 创建可变数组：
    //
    // use slint::VecModel;
    // use std::rc::Rc;
    //
    // let items = Rc::new(VecModel::from(vec![
    //     TodoItem { id: 1, title: "任务1".into(), ... },
    //     TodoItem { id: 2, title: "任务2".into(), ... },
    // ]));
    // app.set_todo_list(items.into());
    //
    // // 添加项目
    // items.push(new_item);
    //
    // // 删除项目
    // items.remove(index);
    //
    // // 修改项目
    // items.set_row_data(index, updated_item);
    in-out property <[TodoItem]> todo-list;

    // 输入状态
    in-out property <string> new-todo-title: "";
    in-out property <string> new-todo-priority: "中";

    // 统计属性（只读，由 Rust 设置）
    in property <int> total-count: 0;
    in property <int> completed-count: 0;

    VerticalLayout {
        padding: 20px;
        spacing: 15px;

        Text {
            text: "待办事项列表";
            font-size: 24px;
            font-weight: bold;
            color: #333;
            horizontal-alignment: center;
        }

        // 统计信息显示
        HorizontalLayout {
            spacing: 15px;
            alignment: center;

            Text {
                text: "总计: " + total-count;
                font-size: 14px;
                color: #666;
            }

            Text {
                text: "已完成: " + completed-count;
                font-size: 14px;
                color: #009900;
            }
        }

        // ====================================================================
        // 输入区域
        // ====================================================================
        VerticalLayout {
            spacing: 10px;

            HorizontalLayout {
                spacing: 10px;

                // 标题输入框
                LineEdit {
                    text: new-todo-title;
                    placeholder-text: "输入新的待办事项...";
                    width: 250px;

                    on-text-changed: {
                        new-todo-title = text;
                    }
                }

                // 优先级选择按钮组
                HorizontalLayout {
                    spacing: 5px;

                    Button {
                        text: "高";
                        width: 50px;
                        background: new-todo-priority == "高" ? #ff4444 : #e0e0e0;
                        color: new-todo-priority == "高" ? white : #333;
                        on-clicked: {
                            new-todo-priority = "高";
                        }
                    }

                    Button {
                        text: "中";
                        width: 50px;
                        background: new-todo-priority == "中" ? #ff9900 : #e0e0e0;
                        color: new-todo-priority == "中" ? white : #333;
                        on-clicked: {
                            new-todo-priority = "中";
                        }
                    }

                    Button {
                        text: "低";
                        width: 50px;
                        background: new-todo-priority == "低" ? #009900 : #e0e0e0;
                        color: new-todo-priority == "低" ? white : #333;
                        on-clicked: {
                            new-todo-priority = "低";
                        }
                    }
                }

                // 添加按钮
                Button {
                    text: "添加";
                    width: 80px;
                    background: #0066cc;
                    color: white;
                    // 输入为空时禁用
                    enabled: new-todo-title != "";

                    on-clicked: {
                        // 调用回调，由 Rust 添加项目
                        add-todo-item(new-todo-title, new-todo-priority);
                        // 清空输入
                        new-todo-title = "";
                    }
                }
            }
        }

        // ====================================================================
        // 列表渲染区域
        // ====================================================================
        // ScrollView: 可滚动容器，适合长列表
        ScrollView {
            width: 100%;
            height: 300px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;

            VerticalLayout {
                spacing: 8px;
                padding: 10px;

                // ============================================================
                // for-in 循环 - 列表渲染核心语法
                // ============================================================
                // 语法：for variable in array: Element { ... }
                // 语法：for variable[index] in array: Element { ... }
                //
                // 【原理】
                // 1. 遍历 todo-list 数组
                // 2. 为每个 todo 创建 TodoItemComponent 实例
                // 3. 将 todo 数据传递给组件
                //
                // 【与 Rust 的关联】
                // 当 Rust 修改数组时：
                // items.push(new_item);  // 添加 → 创建新组件
                // items.remove(index);   // 删除 → 移除组件
                // items.set_row_data();  // 修改 → 更新组件
                //
                // 【注意】Slint 0.x 语法使用大括号
                // Slint 1.x 不需要大括号
                for todo in todo-list: {
                    TodoItemComponent {
                        item: todo;  // 传递数据给子组件
                    }
                }

                // ============================================================
                // 空列表提示 - 条件渲染
                // ============================================================
                // todo-list.length: 获取数组长度
                // 当数组为空时显示提示
                if todo-list.length == 0: {
                    Text {
                        text: "暂无待办事项";
                        font-size: 16px;
                        color: #999;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        padding: 40px;
                    }
                }
            }
        }

        // 操作按钮
        HorizontalLayout {
            spacing: 10px;
            alignment: center;

            Button {
                text: "删除已完成";
                enabled: completed-count > 0;
                on-clicked: {
                    delete-completed();
                }
            }

            Button {
                text: "清空所有";
                enabled: total-count > 0;
                background: #ff4444;
                color: white;
                on-clicked: {
                    clear-all();
                }
            }
        }
    }

    // ========================================================================
    // 回调声明 - 操作接口
    // ========================================================================
    // 这些回调由 Rust 实现，处理列表的增删改操作
    //
    // 【Rust 实现示例】
    // app.on_add_todo_item(move |title, priority| {
    //     let new_item = TodoItem { ... };
    //     items.push(new_item);
    //     update_counts();
    // });
    //
    // app.on_remove_item(move |id| {
    //     let index = find_index_by_id(id);
    //     items.remove(index);
    //     update_counts();
    // });

    // 添加新项目
    callback add-todo-item(string, string);

    // 删除指定项目
    callback remove-item(int);

    // 删除所有已完成项目
    callback delete-completed();

    // 清空所有项目
    callback clear-all();
}

// ============================================================================
// 【知识点总结】
// ============================================================================
//
// 1. 数组类型
//    <[T]>           - 数组类型
//    [item1, item2]  - 数组字面量
//    array.length    - 数组长度
//
// 2. for-in 循环
//    for item in array: Element { }
//    for item[index] in array: Element { }
//    为每个元素创建 UI 实例
//
// 3. 结构体数组
//    export struct ItemType { ... }
//    property <[ItemType]> items;
//    Rust 中使用 VecModel<ItemType>
//
// 4. Rust 数组操作
//    VecModel::from(vec![...])  - 创建
//    model.push(item)           - 添加
//    model.remove(index)        - 删除
//    model.set_row_data(i, v)   - 修改
//    model.row_count()          - 数量
//
// 5. 性能优化
//    - Slint 内置 diff 算法
//    - 大列表使用 ListView
//    - 避免频繁重建数组
//
// 6. 列表项组件
//    - 封装为独立组件
//    - 接收单个数据项
//    - 通过回调通知操作
//
// 7. 与 Rust 的关系
//    .slint: 定义 UI 和数据结构
//    .rs:    管理数据和业务逻辑
//    桥梁:   property 传递数据，callback 处理操作
// ============================================================================
