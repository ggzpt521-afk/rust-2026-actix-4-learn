// ============================================================================
// 09_async_data.slint - Slint å¼‚æ­¥æ•°æ®äº¤äº’ç¤ºä¾‹
// ============================================================================
//
// ã€æ–‡ä»¶è¯´æ˜ã€‘
// æœ¬æ–‡ä»¶æ¼”ç¤º Slint çš„å¼‚æ­¥æ•°æ®å¤„ç†æ¨¡å¼
// å¼‚æ­¥æ˜¯ç°ä»£åº”ç”¨çš„å…³é”®ï¼šç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶ I/Oã€é•¿æ—¶é—´è®¡ç®—
//
// ã€ä¸ .rs æ–‡ä»¶çš„å…³è”ã€‘
// - å¼‚æ­¥æ“ä½œåœ¨ Rust ä¸­æ‰§è¡Œï¼ˆåå°çº¿ç¨‹ï¼‰
// - UI çº¿ç¨‹ä¿æŒå“åº”
// - é€šè¿‡ invoke_from_event_loop å®‰å…¨æ›´æ–° UI
// - callback è§¦å‘å¼‚æ­¥æ“ä½œï¼Œproperty æ¥æ”¶ç»“æœ
//
// ã€å¼‚æ­¥å¤„ç†åŸç†ã€‘
// 1. UI è¿è¡Œåœ¨ä¸»çº¿ç¨‹ï¼ˆäº‹ä»¶å¾ªç¯ï¼‰
// 2. è€—æ—¶æ“ä½œåœ¨åå°çº¿ç¨‹æ‰§è¡Œ
// 3. å®Œæˆåé€šè¿‡ invoke_from_event_loop å›åˆ°ä¸»çº¿ç¨‹
// 4. æ›´æ–° UI å±æ€§ï¼Œè§¦å‘é‡æ–°æ¸²æŸ“
//
// ã€ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥ã€‘
// - é˜»å¡ä¸»çº¿ç¨‹ä¼šå¯¼è‡´ UI å†»ç»“
// - ç”¨æˆ·ä½“éªŒå·®ï¼ˆæ— å“åº”ï¼‰
// - ç³»ç»Ÿå¯èƒ½åˆ¤å®šç¨‹åº"æœªå“åº”"
// ============================================================================

// ============================================================================
// ç»“æ„ä½“å®šä¹‰ - å¤©æ°”æ•°æ®æ¨¡å‹
// ============================================================================
// å®šä¹‰ä»å¼‚æ­¥æ“ä½œè¿”å›çš„æ•°æ®ç»“æ„
//
// ã€ä¸ Rust çš„å…³è”ã€‘
// ç”Ÿæˆå¯¹åº”çš„ Rust ç»“æ„ä½“ï¼Œç”¨äºä¼ é€’å¼‚æ­¥ç»“æœï¼š
//
// let weather = WeatherData {
//     city: "åŒ—äº¬".into(),
//     temperature: 22,
//     description: "æ™´æœ—".into(),
//     humidity: 45,
//     wind_speed: 12,
//     icon: "â˜€ï¸".into(),
// };
// app.set_weather_data(weather);
export struct WeatherData {
    city: string,          // åŸå¸‚å
    temperature: int,      // æ¸©åº¦
    description: string,   // å¤©æ°”æè¿°
    humidity: int,         // æ¹¿åº¦
    wind_speed: int,       // é£é€Ÿ
    icon: string,          // å¤©æ°”å›¾æ ‡ï¼ˆemojiï¼‰
}

// ============================================================================
// ä¸»åº”ç”¨ç»„ä»¶
// ============================================================================
export component AsyncData {
    width: 450px;
    height: 400px;

    // ========================================================================
    // åº”ç”¨çŠ¶æ€å±æ€§
    // ========================================================================
    // è¿™äº›å±æ€§ç”¨äºè·Ÿè¸ªå¼‚æ­¥æ“ä½œçš„çŠ¶æ€å’Œç»“æœ
    //
    // ã€çŠ¶æ€ç®¡ç†æ¨¡å¼ã€‘
    // å¼‚æ­¥æ“ä½œé€šå¸¸éœ€è¦ä¸‰ä¸ªçŠ¶æ€ï¼š
    // 1. is-loading: æ˜¯å¦æ­£åœ¨åŠ è½½
    // 2. has-error: æ˜¯å¦å‘ç”Ÿé”™è¯¯
    // 3. result-data: æ“ä½œç»“æœ
    //
    // ã€çŠ¶æ€æµè½¬ã€‘
    // åˆå§‹ â†’ åŠ è½½ä¸­ â†’ æˆåŠŸ/å¤±è´¥ â†’ åˆå§‹ï¼ˆå¯é‡è¯•ï¼‰

    // åŠ è½½çŠ¶æ€
    in-out property <bool> is-loading: false;

    // çŠ¶æ€æ¶ˆæ¯
    in-out property <string> status-message: "ç‚¹å‡»æŒ‰é’®è·å–å¤©æ°”æ•°æ®";

    // é”™è¯¯çŠ¶æ€
    in-out property <bool> has-error: false;

    // å¤©æ°”æ•°æ®ï¼ˆå¼‚æ­¥æ“ä½œç»“æœï¼‰
    // ä½¿ç”¨ç»“æ„ä½“å­˜å‚¨å¤æ‚æ•°æ®
    in-out property <WeatherData> weather-data: {
        city: "",
        temperature: 0,
        description: "",
        humidity: 0,
        wind_speed: 0,
        icon: "â˜€ï¸"
    };

    // ç”¨æˆ·è¾“å…¥
    in-out property <string> city-name: "åŒ—äº¬";

    VerticalLayout {
        padding: 20px;
        spacing: 15px;

        Text {
            text: "å¼‚æ­¥æ•°æ®äº¤äº’ç¤ºä¾‹";
            font-size: 24px;
            font-weight: bold;
            color: #333;
            horizontal-alignment: center;
        }

        // ====================================================================
        // è¾“å…¥åŒºåŸŸ
        // ====================================================================
        HorizontalLayout {
            spacing: 10px;
            alignment: center;

            // åŸå¸‚åè¾“å…¥
            LineEdit {
                text: city-name;
                placeholder-text: "è¾“å…¥åŸå¸‚å";
                width: 200px;
                // åŒå‘ç»‘å®š
                on-text-changed: { city-name = text; }
            }

            // è·å–æ•°æ®æŒ‰é’®
            Button {
                text: "è·å–å¤©æ°”";
                // åŠ è½½ä¸­æˆ–è¾“å…¥ä¸ºç©ºæ—¶ç¦ç”¨
                enabled: !is-loading && city-name != "";
                on-clicked: {
                    // æ›´æ–°çŠ¶æ€ï¼šå¼€å§‹åŠ è½½
                    is-loading = true;
                    has-error = false;
                    status-message = "æ­£åœ¨è·å–å¤©æ°”æ•°æ®...";
                    // è°ƒç”¨å›è°ƒï¼Œè§¦å‘ Rust ç«¯çš„å¼‚æ­¥æ“ä½œ
                    fetch-weather(city-name);
                }
            }
        }

        // ====================================================================
        // çŠ¶æ€æ¶ˆæ¯
        // ====================================================================
        // æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒé¢œè‰²
        Text {
            text: status-message;
            font-size: 14px;
            // æ¡ä»¶è¡¨è¾¾å¼ï¼šé”™è¯¯æ—¶çº¢è‰²ï¼Œå¦åˆ™ç°è‰²
            color: has-error ? #cc0000 : #666;
            horizontal-alignment: center;
        }

        // ====================================================================
        // åŠ è½½æŒ‡ç¤ºå™¨
        // ====================================================================
        // æ¡ä»¶æ¸²æŸ“ï¼šä»…åœ¨åŠ è½½æ—¶æ˜¾ç¤º
        if is-loading: {
            HorizontalLayout {
                spacing: 10px;
                alignment: center;
                vertical-alignment: center;

                // ç®€å•çš„åŠ è½½åŠ¨ç”»ï¼ˆå®é™…å¯ä»¥ç”¨æ›´å¤æ‚çš„åŠ¨ç”»ï¼‰
                Rectangle {
                    width: 20px;
                    height: 20px;
                    background: #0066cc;
                    border-radius: 50%;
                    opacity: 0.7;
                }

                Text {
                    text: "åŠ è½½ä¸­...";
                    font-size: 16px;
                    color: #0066cc;
                }
            }
        }

        // ====================================================================
        // å¤©æ°”æ•°æ®å¡ç‰‡
        // ====================================================================
        // æ¡ä»¶æ¸²æŸ“ï¼šæœ‰æ•°æ®æ—¶æ˜¾ç¤º
        // else if: ä¸åŠ è½½ä¸”æœ‰æ•°æ®æ—¶
        else if weather-data.city != "": {
            Rectangle {
                width: 100%;
                background: #ffffff;
                border: 1px solid #e0e0e0;
                border-radius: 12px;
                padding: 20px;
                // é˜´å½±æ•ˆæœ
                shadow-offset-y: 2px;
                shadow-blur: 8px;
                shadow-color: rgba(0, 0, 0, 0.1);

                VerticalLayout {
                    spacing: 15px;
                    alignment: center;

                    // åŸå¸‚å’Œå›¾æ ‡
                    HorizontalLayout {
                        spacing: 15px;
                        vertical-alignment: center;

                        // å¤©æ°”å›¾æ ‡
                        Text {
                            text: weather-data.icon;
                            font-size: 48px;
                        }

                        // åŸå¸‚å
                        Text {
                            text: weather-data.city;
                            font-size: 28px;
                            font-weight: bold;
                            color: #333;
                        }
                    }

                    // æ¸©åº¦
                    Text {
                        // æ•°å­—æ‹¼æ¥å­—ç¬¦ä¸²
                        text: weather-data.temperature + "Â°C";
                        font-size: 48px;
                        color: #ff6600;
                        font-weight: bold;
                    }

                    // å¤©æ°”æè¿°
                    Text {
                        text: weather-data.description;
                        font-size: 18px;
                        color: #666;
                    }

                    // è¯¦ç»†ä¿¡æ¯
                    HorizontalLayout {
                        spacing: 25px;

                        // æ¹¿åº¦
                        VerticalLayout {
                            spacing: 5px;
                            alignment: center;

                            Text {
                                text: "ğŸ’§";
                                font-size: 24px;
                            }

                            Text {
                                text: weather-data.humidity + "%";
                                font-size: 14px;
                                color: #666;
                            }

                            Text {
                                text: "æ¹¿åº¦";
                                font-size: 12px;
                                color: #999;
                            }
                        }

                        // é£é€Ÿ
                        VerticalLayout {
                            spacing: 5px;
                            alignment: center;

                            Text {
                                text: "ğŸ’¨";
                                font-size: 24px;
                            }

                            Text {
                                text: weather-data.wind_speed + " km/h";
                                font-size: 14px;
                                color: #666;
                            }

                            Text {
                                text: "é£é€Ÿ";
                                font-size: 12px;
                                color: #999;
                            }
                        }
                    }
                }
            }
        }

        // ====================================================================
        // è¯´æ˜æ–‡å­—
        // ====================================================================
        Text {
            text: "æœ¬ç¤ºä¾‹å±•ç¤ºäº†å¼‚æ­¥æ•°æ®å¤„ç†ï¼š\n"
                 + "â€¢ ç½‘ç»œè¯·æ±‚åœ¨åå°çº¿ç¨‹æ‰§è¡Œ\n"
                 + "â€¢ UI ä¿æŒå“åº”çŠ¶æ€\n"
                 + "â€¢ æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨\n"
                 + "â€¢ å¤„ç†æˆåŠŸå’Œé”™è¯¯æƒ…å†µ\n"
                 + "â€¢ æ›´æ–° UI æ˜¾ç¤ºå¼‚æ­¥ç»“æœ";
            font-size: 12px;
            color: #666;
            line-height: 1.5;
            horizontal-alignment: center;
            width: 350px;
            word-wrap: true;
        }
    }

    // ========================================================================
    // å›è°ƒå£°æ˜ - å¼‚æ­¥æ“ä½œæ¥å£
    // ========================================================================
    // è¿™ä¸ªå›è°ƒç”± Rust å®ç°ï¼Œæ‰§è¡Œå®é™…çš„å¼‚æ­¥æ“ä½œ
    //
    // ã€Rust å®ç°ç¤ºä¾‹ã€‘
    //
    // let app_weak = app.as_weak();
    //
    // app.on_fetch_weather(move |city| {
    //     let app_weak = app_weak.clone();
    //     let city = city.to_string();
    //
    //     // åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œå¼‚æ­¥æ“ä½œ
    //     thread::spawn(move || {
    //         // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    //         thread::sleep(Duration::from_secs(1));
    //
    //         // è·å–å¤©æ°”æ•°æ®ï¼ˆå®é™…åº”ç”¨ä¸­æ˜¯ç½‘ç»œè¯·æ±‚ï¼‰
    //         let result = fetch_weather_api(&city);
    //
    //         // å›åˆ°ä¸»çº¿ç¨‹æ›´æ–° UI
    //         slint::invoke_from_event_loop(move || {
    //             if let Some(app) = app_weak.upgrade() {
    //                 match result {
    //                     Ok(data) => {
    //                         app.set_weather_data(data);
    //                         app.set_status_message("è·å–æˆåŠŸ!".into());
    //                         app.set_has_error(false);
    //                     }
    //                     Err(e) => {
    //                         app.set_status_message(format!("é”™è¯¯: {}", e).into());
    //                         app.set_has_error(true);
    //                     }
    //                 }
    //                 app.set_is_loading(false);
    //             }
    //         }).unwrap();
    //     });
    // });
    //
    // ã€å…³é”®ç‚¹ã€‘
    // 1. as_weak(): åˆ›å»ºå¼±å¼•ç”¨ï¼Œé¿å…å¾ªç¯å¼•ç”¨
    // 2. thread::spawn: åœ¨æ–°çº¿ç¨‹æ‰§è¡Œ
    // 3. invoke_from_event_loop: å®‰å…¨å›åˆ°ä¸»çº¿ç¨‹
    // 4. upgrade(): å°è¯•å°†å¼±å¼•ç”¨è½¬ä¸ºå¼ºå¼•ç”¨
    callback fetch-weather(string);
}

// ============================================================================
// ã€çŸ¥è¯†ç‚¹æ€»ç»“ã€‘
// ============================================================================
//
// 1. å¼‚æ­¥çŠ¶æ€æ¨¡å¼
//    is-loading      - åŠ è½½ä¸­çŠ¶æ€
//    has-error       - é”™è¯¯çŠ¶æ€
//    status-message  - çŠ¶æ€æ¶ˆæ¯
//    result-data     - ç»“æœæ•°æ®
//
// 2. Rust å¼‚æ­¥å¤„ç†
//    thread::spawn       - åˆ›å»ºæ–°çº¿ç¨‹
//    thread::sleep       - æ¨¡æ‹Ÿå»¶è¿Ÿ
//    invoke_from_event_loop - å›åˆ°ä¸»çº¿ç¨‹
//
// 3. å¼±å¼•ç”¨
//    as_weak()      - åˆ›å»ºå¼±å¼•ç”¨
//    upgrade()      - å°è¯•è½¬ä¸ºå¼ºå¼•ç”¨
//    é¿å…å¾ªç¯å¼•ç”¨å’Œå†…å­˜æ³„æ¼
//
// 4. çº¿ç¨‹å®‰å…¨
//    Slint UI ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„
//    åªèƒ½åœ¨ä¸»çº¿ç¨‹ä¿®æ”¹å±æ€§
//    invoke_from_event_loop ä¿è¯å®‰å…¨
//
// 5. æ¡ä»¶æ¸²æŸ“
//    if is-loading: { }     - åŠ è½½æ—¶
//    else if has-data: { }  - æœ‰æ•°æ®æ—¶
//    else: { }              - é»˜è®¤çŠ¶æ€
//
// 6. æ•°æ®ç»“æ„
//    export struct å®šä¹‰å¤æ‚æ•°æ®
//    Rust ç”Ÿæˆå¯¹åº”ç»“æ„ä½“
//    ç”¨äºä¼ é€’å¼‚æ­¥ç»“æœ
//
// 7. å›è°ƒæœºåˆ¶
//    callback fetch-weather(string);
//    UI è§¦å‘ï¼ŒRust æ‰§è¡Œ
//    ç»“æœé€šè¿‡ property è¿”å›
//
// 8. ä¸ .rs çš„å…³ç³»
//    .slint: å®šä¹‰ UI å’ŒçŠ¶æ€
//    .rs:    æ‰§è¡Œå¼‚æ­¥æ“ä½œ
//    æ¡¥æ¢:   callback è§¦å‘ï¼Œproperty è¿”å›ç»“æœ
//
// 9. æ›¿ä»£æ–¹æ¡ˆ
//    tokio + slint: ä½¿ç”¨ tokio è¿è¡Œæ—¶
//    async-std: å¦ä¸€ä¸ªå¼‚æ­¥è¿è¡Œæ—¶
//    channel: std::sync::mpsc æˆ– crossbeam
// ============================================================================
